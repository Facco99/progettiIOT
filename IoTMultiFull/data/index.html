<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- <meta http-equiv='refresh' content='5'> -->
    <link rel="icon" href="data:," />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="http://bernii.github.io/gauge.js/dist/gauge.min.js"></script>
</head>

<script>
    //Impostazioni Gauge
    var opts = {
        angle: 0,
        lineWidth: 0.1,
        radiusScale: 0.58,
        pointer: {
            length: 0.6,
            strokeWidth: 0.035,
            color: '#000000'
        },
        limitMax: false,
        limitMin: false,
        colorStart: '#ff4f38',
        colorStop: '#ff4f38',
        strokeColor: '#EEEEEE',
        generateGradient: true,
        highDpiSupport: true,
    };

    var gauge1, gauge2, gauge3, gauge4;

    //Inizializzo i Gauge quando viene caricata la pagina
    function onLoad() {
        var target1 = document.getElementById('analogInput0');
        var target2 = document.getElementById('analogInput1');
        var target3 = document.getElementById('analogInput2');
        var target4 = document.getElementById('analogInput3');

        gauge1 = new Donut(target1).setOptions(opts);
        gauge1.maxValue = 10;
        gauge1.setMinValue(0);
        gauge1.animationSpeed = 32;
        gauge1.set(0);

        gauge2 = new Donut(target2).setOptions(opts);
        gauge2.maxValue = 10;
        gauge2.setMinValue(0);
        gauge2.animationSpeed = 32;
        gauge2.set(0);

        gauge3 = new Donut(target3).setOptions(opts);
        gauge3.maxValue = 10;
        gauge3.setMinValue(0);
        gauge3.animationSpeed = 32;
        gauge3.set(0);

        gauge4 = new Donut(target4).setOptions(opts);
        gauge4.maxValue = 10;
        gauge4.setMinValue(0);
        gauge4.animationSpeed = 32;
        gauge4.set(0);
    }

    //Funzione per accensione e spegnimento relay
    function toggleCheckbox(element) {
        var xhr = new XMLHttpRequest();
        if (element.checked) {
            xhr.open("GET", "/update?output=" + element.id + "&state=1", true);
        } else {
            xhr.open("GET", "/update?output=" + element.id + "&state=0", true);
        }
        xhr.send();
    }

    //Funzione per modifica valori slider
    function updateSliderPWM(element) {
        var xhr = new XMLHttpRequest();
        if (element.id == "aOut1") {
            var sliderValue1 = document.getElementById("aOut1").value;
            xhr.open(
                "GET",
                "/slider?id=" + element.id + "&value=" + sliderValue1,
                true
            );
        } else if (element.id == "aOut2") {
            var sliderValue2 = document.getElementById("aOut2").value;
            xhr.open(
                "GET",
                "/slider?id=" + element.id + "&value=" + sliderValue2,
                true
            );
        } else if (element.id == "aOut3") {
            var sliderValue3 = document.getElementById("aOut3").value;
            xhr.open(
                "GET",
                "/slider?id=" + element.id + "&value=" + sliderValue3,
                true
            );
        } else if (element.id == "aOut4") {
            var sliderValue4 = document.getElementById("aOut4").value;
            xhr.open(
                "GET",
                "/slider?id=" + element.id + "&value=" + sliderValue4,
                true
            );
        }
        xhr.send();
    }

    //Ogni secondo ricevo un file JSON con tutti dati
    setInterval(function() {
        axios.get(`/json`) //Leggo la chiamata get tramite axios
            .then(response => {
                const data = response.data;

                //Accendo e spengo il led in base ai valori ricevuti dal file JSON
                data.digitalInput1 == 0 ? document.getElementById("button0").className = "dotOff" : document.getElementById("button0").className = "dotOn"
                data.digitalInput2 == 0 ? document.getElementById("button1").className = "dotOff" : document.getElementById("button1").className = "dotOn"
                data.digitalInput3 == 0 ? document.getElementById("button2").className = "dotOff" : document.getElementById("button2").className = "dotOn"
                data.digitalInput4 == 0 ? document.getElementById("button3").className = "dotOff" : document.getElementById("button3").className = "dotOn";
                //Aggiorno i dati dei relay, se modifico da Blynk lo stato del relay non devo aggiornare la pagina
                data.digitalOutput1 == 0 ? document.getElementById("relay1").checked = false : document.getElementById("relay1").checked = true
                data.digitalOutput2 == 0 ? document.getElementById("relay2").checked = false : document.getElementById("relay2").checked = true
                data.digitalOutput3 == 0 ? document.getElementById("relay3").checked = false : document.getElementById("relay3").checked = true
                data.digitalOutput4 == 0 ? document.getElementById("relay4").checked = false : document.getElementById("relay4").checked = true;
                //Modifico il valore dei Gauge
                gauge1.set(data.analogInput1);
                gauge2.set(data.analogInput2);
                gauge3.set(data.analogInput3);
                gauge4.set(data.analogInput4);
                //Aggiorno i dati degli slider, se modifico da Blynk non devo aggiornare la pagina
                document.getElementById("aOut1").value = data.analogOutput1
                document.getElementById("aOut2").value = data.analogOutput2
                document.getElementById("aOut3").value = data.analogOutput3
                document.getElementById("aOut4").value = data.analogOutput4;
                //Aggiorno i dati delle sonde di temperatura
                data.sonda1 > 640 ? document.getElementById("sonda0").innerHTML = "Sonda non collegata" : document.getElementById("sonda0").innerHTML = data.sonda1 + " Gradi"
                data.sonda2 > 640 ? document.getElementById("sonda1").innerHTML = "Sonda non collegata" : document.getElementById("sonda1").innerHTML = data.sonda2 + " Gradi"
                data.sonda3 > 640 ? document.getElementById("sonda2").innerHTML = "Sonda non collegata" : document.getElementById("sonda2").innerHTML = data.sonda3 + " Gradi"
                data.sonda4 > 640 ? document.getElementById("sonda3").innerHTML = "Sonda non collegata" : document.getElementById("sonda3").innerHTML = data.sonda4 + " Gradi"
            })
            .catch(error => console.error('Dati non ricevuti', error))
    }, 1500);
</script>

<body onload="onLoad()">
    <div class="grid-container">
        <div class="grid-item">
            <h2>Output Digitali</h2>
            <table class="text-align">
                <th>%RELAY1%</th>
                <td><label class="switch"><input type="checkbox" onchange="toggleCheckbox(this)" id="relay1"><span class="slider"></span></label></td>
                <tr>
                    <th>%RELAY2%</th>
                    <td><label class="switch"><input type="checkbox" onchange="toggleCheckbox(this)" id="relay2"><span class="slider"></span></label></td>
                    <tr>
                        <th>%RELAY3%</th>
                        <td><label class="switch"><input type="checkbox" onchange="toggleCheckbox(this)" id="relay3"><span class="slider"></span></label></td>
                        <tr>
                            <th>%RELAY4%</th>
                            <td><label class="switch"><input type="checkbox" onchange="toggleCheckbox(this)" id="relay4"><span class="slider"></span></label></td>
            </table>
        </div>
        <div class="grid-item">
            <h2>Sonde</h2>
            <table class="text-align sonde">
                <th>%SONDA1%</th>
                <td id="sonda0">Sonda non collegata</td>
                <tr>
                    <th>%SONDA2%</th>
                    <td id="sonda1">Sonda non collegata</td>
                    <tr>
                        <th>%SONDA3%</th>
                        <td id="sonda2">Sonda non collegata</td>
                        <tr>
                            <th>%SONDA4%</th>
                            <td id="sonda3">Sonda non collegata</td>
            </table>
        </div>
        <div class="grid-item">
            <h2>Output Analogici</h2>
            <table>
                <th>%ANALOGOUTPUT1%</th>
                <td><input type="range" class="analogSlider" onmouseup="updateSliderPWM(this)" ontouchend="updateSliderPWM(this)" id="aOut1" min="0" max="255"></td>
                <tr>
                    <th>%ANALOGOUTPUT2%</th>
                    <td><input type="range" class="analogSlider" onmouseup="updateSliderPWM(this)" ontouchend="updateSliderPWM(this)" id="aOut2" min="0" max="255"></td>
                    <tr>
                        <th>%ANALOGOUTPUT3%</th>
                        <td><input type="range" class="analogSlider" onmouseup="updateSliderPWM(this)" ontouchend="updateSliderPWM(this)" id="aOut3" min="0" max="255"></td>
                        <tr>
                            <th>%ANALOGOUTPUT4%</th>
                            <td><input type="range" class="analogSlider" onmouseup="updateSliderPWM(this)" ontouchend="updateSliderPWM(this)" id="aOut4" min="0" max="255"></td>
            </table>
        </div>
        <div class="grid-item">
            <h2>Input Digitali</h2>
            <table class="input">
                <th>%DIGITALINPUT1%</th>
                <td><button class="dotOff" id="button0" disabled></button></td>
                <th>%DIGITALINPUT2%</th>
                <td><button class="dotOff" id="button1" disabled></button></td>
                <tr>
                    <th>%DIGITALINPUT3%</th>
                    <td><button class="dotOff" id="button2" disabled></button></td>
                    <th>%DIGITALINPUT4%</th>
                    <td><button class="dotOff" id="button3" disabled></button></td>

            </table>
        </div>
        <div class="grid-item">
            <a href="/inserimento"><button class="button">Inserisci nomi campi</button></a>
        </div>
        <div class="grid-item">
            <h2>Input Analogici</h2>
            <table class="input">
                <th>%ANALOGINPUT1%</th>
                <td><canvas id="analogInput0"></canvas></td>
                <th>%ANALOGINPUT2%</th>
                <td><canvas id="analogInput1"></canvas></td>
                <tr>
                    <th>%ANALOGINPUT3%</th>
                    <td><canvas id="analogInput2"></canvas></td>
                    <th>%ANALOGINPUT4%</th>
                    <td><canvas id="analogInput3"></canvas></td>
            </table>
        </div>
    </div>
</body>

</html>